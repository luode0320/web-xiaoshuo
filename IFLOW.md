# 小说阅读系统项目说明

## 项目概述

本项目是一个小说阅读系统，支持多种格式的小说上传、阅读、搜索和社交功能。系统采用前后端分离架构，后端使用Go语言、Gin框架和Gorm ORM，前端使用Vue.js 3，提供类似起点中文网的阅读体验。

系统支持txt和epub格式的小说文件，具备完善的上传、审核、阅读、搜索和社交互动功能。系统仅支持中文。

## 项目结构

```
web-xiaoshuo/
├── backend/
│   ├── main.go           # 主程序入口
│   ├── models/           # 数据模型
│   ├── controllers/      # 控制器
│   ├── routes/           # 路由定义
│   ├── middleware/       # 中间件
│   ├── utils/            # 工具函数
│   ├── config/           # 后端配置
│   └── migrations/       # 数据库迁移
├── frontend/
│   ├── src/
│   │   ├── components/   # 通用组件
│   │   ├── views/        # 页面组件
│   │   ├── assets/       # 静态资源
│   │   ├── router/       # 路由配置
│   │   ├── utils/        # 工具函数
│   │   └── App.vue
│   ├── public/           # 静态资源目录
│   ├── package.json
│   └── vite.config.js
├── backend_requirements.md   # 后端需求文档
├── frontend_requirements.md  # 前端需求文档
├── functional_design.md      # 功能设计文档
└── IFLOW.md                  # 项目说明文档
```

## 技术栈

### 后端技术栈
- Go语言 (1.19+)
- Gin框架 (Web框架)
- Gorm (ORM框架)
- MySQL (数据库)
- Viper (配置管理)
- Logrus (日志管理)
- Godotenv (环境变量管理)
- 用于处理EPUB格式的第三方库（如golang-epub）
- 用于文件类型检测的第三方库（如filetype）
- 用于密码哈希的第三方库（如bcrypt）
- 用于HTTP请求限制的第三方库（如x/time/rate）
- 用于数据验证的第三方库（如validator）
- 用于XSS防护的第三方库（如bluemonday）
- 用于速率限制的第三方库（如x/time/rate）
- 用于定时任务的第三方库（如gocron或robfig/cron）
- 用于精确计算的第三方库（如decimal）
- 用于文件操作的第三方库（如mime/multipart）

### 前端技术栈
- Vue.js 3.x
- Vue Router
- Pinia（状态管理）
- Composition API
- Vite（构建工具）
- Element Plus/Naive UI（UI组件库）
- TypeScript（可选）
- Axios（HTTP请求）
- epub.js（处理EPUB格式）
- vue-virtual-scroll-list（虚拟滚动）
- vue-infinite-loading（无限滚动）
- js-sha256（文件hash验证）
- pinia-plugin-persistedstate（本地存储持久化）
- vee-validate（表单验证）
- DOMPurify（内容安全处理）
- moment.js（时间处理）
- fuse.js（模糊搜索）
- vue3-tree-chart（评论树形结构）

## 核心功能

### 1. 用户管理功能
- 用户注册：使用邮箱注册，只需符合邮箱格式即可完成注册，无需邮箱验证。注册时可选择填写昵称，若未填写则默认使用邮箱作为昵称。昵称不强制唯一，但会在显示时通过颜色或标识区分。
- 用户登录：使用邮箱和密码进行登录，无需验证码。使用JWT进行认证。
- 个人中心：展示用户基本信息和操作历史。
- 昵称管理：用户可在个人中心修改昵称，默认昵称为登录邮箱。
- 用户状态管理：管理员可以冻结/解冻用户账户。被冻结用户无法进行上传、评论、评分、点赞等操作，但仍可登录和阅读已有的小说内容。
- 冻结用户功能限制：
  - 禁止操作：上传小说、发布评论、发布评分、点赞、设置小说分类和关键词
  - 允许操作：登录、阅读已有小说、查看个人中心信息
  - 阅读相关：允许更新阅读进度、记录阅读历史，但不会增加小说点击量
- 冻结用户内容显示：
  - 内容保留：被冻结用户已发布的内容（评论、评分等）会保留在系统中
  - 冻结标识：在显示时标注"发布者已被冻结"的标签，标签样式为灰色徽章形式
  - 排序权重：冻结用户的评论和评分在排序中权重降低，不会影响热门排序
  - 界面标识：被冻结用户在界面上会显示"账户已被冻结"的水印或标识
- 未审核内容管理：管理员可以一键删除被冻结用户的未审核小说
- 管理员权限：通过is_admin字段标识管理员账户，用于执行特定管理操作。管理员权限包括：审核小说（通过/拒绝/退回修改、批量审核）、管理用户（冻结/解冻、查看用户列表）、删除内容（一键删除未审核小说、删除违规评论/评分）、查看系统统计等。
- 操作日志管理：
  - 记录内容：管理员操作会记录到操作日志中，日志包含操作时间、操作人、操作类型、操作对象等信息
  - 查询功能：管理员可按时间范围、操作类型等条件查询操作日志

### 2. 小说管理功能
- 小说上传：支持txt、epub格式小说文件上传，包含文件hash验证防止重复上传
- 小说列表：展示系统中的所有小说，支持无限滚动分页
- 小说详情：显示小说基本信息、简介、字数统计、主角名称等
- 小说分类：按不同类型分类展示小说
- 阅读排行：按阅读次数排序展示小说（总榜、今日榜、本周榜、本月榜）
- 审核机制：上传后小说默认为审核中状态，可选择性过滤查看
- 章节管理：
  - 章节识别：
    - EPUB格式：使用第三方库自动提取章节标题和结构
    - TXT格式：使用第三方库识别章节标记，包括：
      - 中文数字：/^第[一二三四五六七八九十百千万零]+[章节回].*$/
      - 阿拉伯数字：/^第\d+[章节回].*$/
      - 其他格式：/^序[言章]?$|^[前引]言$|^终[章后]$|^后记$/
  - 章节字数统计
- 上传频率限制：
  - 每个用户每日上传小说数量限制为10本，按自然日（00:00-23:59）计算
  - 管理员用户不受此限制
- 批量审核功能：
  - 支持多选操作：管理员在审核页面可通过复选框进行多选，支持Ctrl+点击选择不连续项目、Shift+点击选择连续项目
  - 操作限制：一次最多可选择50本小说，以提高审核效率
  - 批量操作类型：支持批量通过、批量拒绝、批量退回修改
- 审核时效管理：
  - 小说在审核中状态最长保留30天
  - 使用定时任务每24小时检查一次过期小说
  - 超过期限未审核的小说自动转为拒绝状态并通知上传用户
- 审核标准：
  - 格式标准：文件格式正确，能被阅读器正常解析
  - 完整性标准：文件无损坏，章节结构完整
  - 元数据标准：标题、作者等元数据完整且格式正确
  - 大小标准：文件大小在合理范围内（最小1KB，最大20MB）
  - 内容标准：无明显乱码、特殊字符等影响阅读的内容
- 分类设置：必须登录用户才能为小说设置分类和关键词。当用户阅读进度按照字数位置的百分比达到20%以上时，可以在最后一页为小说设置分类和关键词。

### 3. 阅读功能
- 在线阅读：提供流畅的小说阅读体验
- 阅读进度：自动保存用户阅读进度
- 书签功能：用户可添加和管理书签
- 个性化设置：字体、背景、间距等阅读界面定制
- 阅读模式：支持滚动模式和翻页模式
- 翻页功能：点击阅读内容区域左右两侧实现翻页
- 点击量统计：在进入小说第一章（即开始阅读）时调用接口记录点击量
- 跨设备同步机制：
  - 本地存储数据仅在当前设备和浏览器中有效
  - 服务器存储支持跨设备同步
  - 同步策略：当用户在多个设备上同时阅读时，以最新的阅读进度为准进行同步
  - 时间戳精度：使用毫秒级时间戳进行精确比较
  - 进度精度：百分比保留两位小数（如85.25%）
  - 同步失败时的处理：本地缓存进度，重试机制
- 阅读统计：
  - 记录阅读时长：
    - 统计规则：仅在页面可见且用户有交互时统计，暂停超过30秒则暂停计时
    - 实现方式：计算阅读时间
    - 活跃度判断：结合页面可见性API和用户交互事件判断用户是否在阅读
    - 统计精度：精确到分钟，避免重复计算同一时间段

### 4. 搜索功能
- 小说搜索：按标题、作者、主角名称、小说字数等信息搜索小说
- 模糊搜索：支持模糊匹配，使用第三方库实现，匹配度阈值设定为0.6
- 高级搜索：
  - 多条件组合搜索
  - 搜索结果排序：按匹配度、点击量、评分综合排序
- 搜索历史：保存用户搜索历史（最多保存20条记录）
- 热门搜索：
  - 热门词来源：基于近期的搜索数据统计
  - 更新频率：每小时更新一次
  - 展示数量：最多展示10个热门关键词
- 搜索建议：
  - 触发机制：用户输入时延迟300ms触发
  - 建议数量：最多显示5条建议
  - 数据来源：结合搜索历史和热门搜索提供智能建议

### 5. 社交互动功能
- 评论系统：用户可以对小说章节发表评论
- 评分系统：用户可以对小说进行评分，并可以提供评分说明（最多250个字符，非必填）
- 心得分享：用户可以发布阅读心得
- 评论管理：
  - 评论排序：
    - 按时间排序：最新评论优先或最旧评论优先
    - 按点赞数排序：点赞数高的评论优先
    - 按热度排序：结合点赞数、评论时间、回复数等因子计算热度值
      - 热门评论：24小时内点赞数超过10的评论置顶显示
      - 时间权重：考虑评论的发布时间，较新的评论有一定权重优势
      - 活跃度因子：根据评论的互动情况（点赞、回复）调整权重
  - 评论限制：
    - 同章节评论数：每个用户对同一章节的评论数量限制为5条
    - 评论长度：评论内容最多500字符
    - 评论频率：同一用户连续评论间隔不少于30秒
  - 评论互动：
    - 评论回复：支持对评论进行回复，形成评论线程
    - 评论点赞：用户可以对评论进行点赞，但不能重复点赞
- 评分统计：
  - 实时计算平均分
  - 评分分布统计（各星级评分数量及占比）
  - 简单的异常评分检测：对短时间内大量评分进行基础检测
- 删除权限：
  - 普通用户：只能删除自己发布的评论/评分
  - 管理员：可以删除任何用户的评论/评分，删除时需记录操作日志

### 6. 分类管理功能
- 分类浏览：按分类浏览小说
- 分类推荐：基于内容的推荐，推荐拥有相同分类或者关键字的小说

### 7. 推荐系统
- 基于内容的推荐：
  - 推荐规则：推荐拥有相同分类或者关键字的小说
  - 排序方式：按照阅读量排序的最多3本小说作为推荐
  - 无阅读量处理：默认按ID排序
  - 已读过滤：排除本地存储的已读小说
  - 展示方式：向下滚动即可看到
- 热门推荐：
  - 计算方式：基于点击量、评分、评论数等综合评分推荐
  - 时间衰减：对较早的数据应用时间衰减因子
- 新书推荐：
  - 时间范围：最近7天内上传且审核通过的小说
  - 质量筛选：仅推荐评分高于3星或评论数超过5条的小说
  - 推荐逻辑：按上传时间倒序排列，结合质量指标进行微调
- 个性化推荐：
  - 算法实现：根据用户阅读历史和偏好推荐
  - 更新频率：推荐结果每日更新一次
  - 推荐策略：结合基于内容的推荐，实现简单推荐算法
  - 冷启动问题：对新用户使用热门推荐和分类推荐解决冷启动问题

## 界面设计

### 1. 底部导航栏
- 首页：推荐小说展示
- 分类：小说分类浏览
- 排行榜：阅读次数排行榜
- 上传：上传txt、epub格式小说
- 用户：用户个人中心、注册登录入口（未登录显示登录注册，已登录显示个人中心）

### 2. 首页
- 顶部搜索框：按名称、作者、主角名称、小说字数等搜索小说
- 推荐小说列表：展示推荐小说（名称、logo图片）
- 无限滚动加载更多小说（使用第三方库实现，每页加载10条数据，滚动到距离底部20%时开始加载下一页，当数据加载完毕后显示"已加载全部内容"提示）

### 3. 分类页
- 分类列表：展示各种小说分类
- 默认显示第一个分类的小说列表（名称、logo图片）
- 无限滚动加载更多小说（每页加载10条数据，滚动到距离底部20%时开始加载下一页）

### 4. 排行榜页
- 顶部时间范围选择：总榜、今日榜、本周榜、本月榜
- 排行榜列表：按点击量排序展示小说（名称、logo图片）
- 无限滚动加载更多小说（每页加载10条数据，滚动到距离底部20%时开始加载下一页）

### 5. 上传页
- 上传功能：支持单个或批量上传txt、epub格式文件
- 文件hash验证：上传前计算文件hash防止重复上传
- 上传进度显示：批量上传时每上传一个进度条就前进，直到所有的都上传完成；如果是单个文件，进度条从0到100变化，上传成功后显示100的进度。上传成功后自动刷新当前页面的小说列表（使用第三方库实现）
- 审核状态：上传后小说处于审核中状态
- 小说列表：默认展示审核中和已通过的小说
- 审核过滤：可选择是否过滤审核中的小说
- 无限滚动加载更多小说（每页加载10条数据，滚动到距离底部20%时开始加载下一页）

### 6. 小说详情页
- 小说封面和基本信息
- 小说分类展示
- 小说关键词展示
- 简介和作者信息（部分展示）
- 小说字数统计
- 评分和评论统计
- 章节目录（通过解析小说文件自动生成和上传时提供，第三方库支持，用户可点击目录项跳转到对应章节，当前阅读位置高亮显示）
- 快速开始阅读按钮（点击右侧区域进入第一页，当用户对当前小说的阅读进度低于10%时记录阅读次数）
- 相关推荐：推荐拥有相同分类或者关键字的小说

### 7. 阅读页
- 顶部工具栏：返回、设置、目录
- 阅读内容区域
- 设置面板：字体、主题、间距
- 目录面板：章节列表
- 阅读模式：支持滚动模式和翻页模式
- 翻页功能：点击阅读内容区域左侧30%实现上一页，点击右侧30%实现下页，支持覆盖翻页效果，可通过设置改成上下滚动翻页
- 章节评论：在每一章的最后可以对小说的这一章节进行评论，支持在弹窗中查看和提交评论

### 8. 用户模块
- 用户注册：邮箱格式验证注册
- 用户登录：邮箱和密码登录
- 个人中心：展示用户基本信息、上传历史、评论历史、评分历史
- 用户内容管理：用户可在个人中心查看和管理自己上传的小说、发布的评论、提交的评分

## API接口设计

### 后端API主要接口

#### 用户模块
- `POST /api/v1/users/register` - 用户注册
- `POST /api/v1/users/login` - 用户登录
- `GET /api/v1/users/profile` - 获取用户信息
- `PUT /api/v1/users/profile` - 更新用户信息
- `GET /api/v1/users/novels/uploaded` - 获取用户上传的小说列表
- `GET /api/v1/users/comments` - 获取用户的评论列表
- `GET /api/v1/users/ratings` - 获取用户的评分列表
- `DELETE /api/v1/comments/:id` - 删除评论
- `DELETE /api/v1/ratings/:id` - 删除评分
- `GET /api/v1/admin/users` - 获取用户列表（管理员）
- `POST /api/v1/admin/users/:id/freeze` - 冻结用户（管理员）
- `POST /api/v1/admin/users/:id/unfreeze` - 解冻用户（管理员）
- `DELETE /api/v1/admin/users/:id/pending-novels` - 删除冻结用户的未审核小说（管理员）
- `GET /api/v1/users/unread-messages` - 获取用户未读消息列表

#### 小说模块
- `POST /api/v1/novels/upload` - 上传小说
- `GET /api/v1/novels` - 获取小说列表
- `GET /api/v1/novels/:id` - 获取小说详情
- `GET /api/v1/novels/:id/content` - 获取小说内容
- `POST /api/v1/novels/:id/click` - 记录小说点击量
- `GET /api/v1/search/novels` - 搜索小说
- `DELETE /api/v1/novels/:id` - 删除小说
- `POST /api/v1/novels/:id/classify` - 设置小说分类和关键词
- `GET /api/v1/novels/:id/recommendations` - 获取相关小说推荐

#### 分类模块
- `GET /api/v1/categories` - 获取分类列表
- `GET /api/v1/categories/:id/novels` - 获取分类下的小说

#### 排行榜模块
- `GET /api/v1/rankings` - 获取排行榜

#### 审核模块
- `GET /api/v1/novels/pending` - 获取待审核小说列表
- `POST /api/v1/novels/:id/approve` - 审核小说
- `POST /api/v1/novels/batch-approve` - 批量审核小说
- `GET /api/v1/novels/auto-expire` - 自动审核过期小说

#### 评论模块
- `POST /api/v1/comments` - 发布评论
- `GET /api/v1/comments` - 获取评论列表
- `POST /api/v1/comments/:id/like` - 点赞评论
- `DELETE /api/v1/comments/:id` - 删除评论

#### 评分模块
- `POST /api/v1/ratings` - 评分
- `GET /api/v1/ratings/:novel_id` - 获取评分
- `GET /api/v1/novels/:novel_id/ratings` - 获取小说评分列表
- `POST /api/v1/ratings/:id/like` - 点赞评分
- `DELETE /api/v1/ratings/:id` - 删除评分

#### 阅读进度模块
- `POST /api/v1/novels/:id/progress` - 保存阅读进度
- `GET /api/v1/novels/:id/progress` - 获取阅读进度
- `GET /api/v1/users/reading-history` - 获取用户阅读历史
- `POST /api/v1/novels/progress/batch` - 批量保存阅读进度

## 数据库设计

### 主要数据表

#### 1. 用户表 (users)
- id: 主键，自增
- email: 邮箱（唯一，用于登录）
- password: 密码（加密存储）
- nickname: 昵称（可选，默认为邮箱）
- is_active: 用户状态（布尔值，默认true，false表示被冻结）
- is_admin: 管理员状态（布尔值，默认false，true表示管理员）
- last_login_at: 最后登录时间
- created_at: 创建时间
- updated_at: 更新时间

#### 2. 小说表 (novels)
- id: 主键，自增
- title: 小说标题
- author: 作者
- protagonist: 主角名称
- description: 描述
- file_path: 文件路径
- file_size: 文件大小
- word_count: 字数统计
- click_count: 总点击量
- today_clicks: 今日点击量
- week_clicks: 本周点击量
- month_clicks: 本月点击量
- upload_time: 上传时间
- last_read_time: 最后阅读时间
- status: 小说状态 (pending-审核中, approved-已通过, rejected-已拒绝)
- file_hash: 文件hash值 (用于防止重复上传)
- created_at: 创建时间
- updated_at: 更新时间

#### 3. 管理员操作日志表 (admin_logs)
- id: 主键，自增
- admin_user_id: 执行操作的管理员ID
- action: 操作类型 (approve_novel-审核通过小说, reject_novel-审核拒绝小说, modify_novel-退回修改小说, batch_approve_novel-批量审核小说, freeze_user-冻结用户, unfreeze_user-解冻用户等)
- target_type: 目标类型 (novel-小说, user-用户, comment-评论, rating-评分)
- target_id: 目标ID
- details: 操作详情(json格式)
- result: 操作结果 (success-成功, failed-失败)
- ip_address: 操作IP地址
- created_at: 创建时间
- updated_at: 更新时间

#### 4. 分类表 (categories)
- id: 主键，自增
- name: 分类名
- description: 分类描述
- created_at: 创建时间
- updated_at: 更新时间

#### 5. 评论表 (comments)
- id: 主键，自增
- user_id: 用户ID，外键（关联用户表）
- novel_id: 小说ID，外键
- chapter_id: 章节ID
- parent_id: 父评论ID，自关联（支持一级回复）
- content: 评论内容（最多500字符）
- like_count: 点赞数
- created_at: 创建时间
- updated_at: 更新时间

#### 6. 评分表 (ratings)
- id: 主键，自增
- user_id: 用户ID，外键（关联用户表）
- novel_id: 小说ID，外键
- rating: 评分 (1-5)
- review: 评分说明（对小说的评论，最多250个字符）
- like_count: 点赞数
- created_at: 创建时间
- updated_at: 更新时间

#### 7. 评分点赞表 (rating_likes)
- id: 主键，自增
- user_id: 用户ID，外键（关联用户表）
- rating_id: 评分ID，外键（关联评分表）
- created_at: 创建时间

#### 8. 评论点赞表 (comment_likes)
- id: 主键，自增
- user_id: 用户ID，外键（关联用户表）
- comment_id: 评论ID，外键（关联评论表）
- created_at: 创建时间

#### 9. 关键词表 (keywords)
- id: 主键，自增
- keyword: 关键词
- created_at: 创建时间
- updated_at: 更新时间

#### 10. 小说关键词关联表 (novel_keywords)
- id: 主键，自增
- novel_id: 小说ID，外键
- keyword_id: 关键词ID，外键

#### 11. 小说分类关联表 (novel_categories)
- id: 主键，自增
- novel_id: 小说ID，外键
- category_id: 分类ID，外键

#### 12. 系统消息表 (system_messages)
- id: 主键，自增
- user_id: 接收用户ID
- title: 消息标题
- content: 消息内容
- type: 消息类型 (notification-通知, warning-警告, info-信息)
- is_read: 是否已读（布尔值，默认false）
- created_at: 创建时间
- updated_at: 更新时间

## 性能优化

### 1. 后端优化
- 数据库索引设计（对click_count、today_clicks、week_clicks、month_clicks等字段建立索引）
- 查询优化
- 连接池管理
- Redis缓存集成
- 热点数据缓存
- API响应缓存
- 排行榜数据缓存
- 字数统计缓存
- 点击量更新的异步处理

### 2. 前端优化
- 虚拟滚动（处理长文本，使用第三方库）
- 内容懒加载
- 图片懒加载
- 组件按需加载
- 翻页内容预加载
- 点击区域事件优化
- EPUB内容渲染优化
- API请求缓存
- 请求合并
- 数据压缩
- 内存泄漏防范
- 组件销毁清理
- 定时器清理

### 3. 网络优化
- 无限滚动加载更多内容
- 预加载热门小说内容以提升用户体验
- 渐进式加载

## 安全性

### 数据安全
- 防止SQL注入
- 防止XSS攻击
- 输入内容过滤和验证

### 文件安全
- 文件类型验证
- 文件大小限制
- 恶意文件检测
- 上传路径安全
- 文件hash验证（防止重复上传）

### 访问控制
- API访问频率限制
- 敏感操作验证
- 操作频率限制
- 审核权限控制
- 用户状态验证（冻结用户限制操作）

## 部署方案

- 前后端分离部署
- 数据库独立部署
- 静态资源服务
- Docker支持
- Docker Compose配置
- 多环境部署
- 健康检查接口
- 性能监控
- 错误监控

## 开发约定

### 后端开发约定
- 使用Gin框架进行路由定义
- 使用Gorm进行数据库操作
- 统一错误处理机制
- 日志记录规范
- 配置文件管理（使用Viper）
- 代码结构按功能模块划分

### 前端开发约定
- 使用Composition API
- 组件按功能模块划分
- 状态管理使用Pinia
- 路由按页面结构组织
- 统一API请求处理
- 组件命名规范
- 代码格式化规范

## 项目管理

### 1. 版本控制
- 使用Git进行版本控制
- 分支策略：main为生产分支，develop为开发分支，feature分支用于新功能开发
- 提交规范：使用约定式提交（Conventional Commits）

### 2. 测试策略
- 单元测试：对核心业务逻辑进行测试
- 集成测试：测试API接口和数据交互
- 端到端测试：测试用户操作流程

### 3. 文档管理
- API文档：使用Swagger生成API文档
- 代码注释：遵循项目注释规范
- 项目文档：维护README、开发指南等文档

## 第三方库管理

### 后端依赖
- Gin: Web框架
- Gorm: ORM框架
- Viper: 配置管理
- Logrus: 日志管理
- filetype: 文件类型检测
- golang-epub: EPUB格式处理
- golang.org/x/time/rate: 速率限制
- validator: 数据验证
- bluemonday: XSS防护
- go-redis: Redis缓存
- bcrypt: 密码哈希
- mime/multipart: 文件上传处理
- gocron或robfig/cron: 定时任务

### 前端依赖
- Vue.js 3.x: 前端框架
- Vue Router: 路由管理
- Pinia: 状态管理
- Element Plus/Naive UI: UI组件库
- Axios: HTTP请求
- epub.js: EPUB格式处理
- vue-virtual-scroll-list: 长文本虚拟滚动
- vue-infinite-loading: 无限滚动加载
- js-sha256: 文件hash计算
- pinia-plugin-persistedstate: 本地存储持久化
- vee-validate: 表单验证
- DOMPurify: 内容安全处理
- moment.js: 时间处理
- fuse.js: 模糊搜索
- vue3-tree-chart: 评论树形结构