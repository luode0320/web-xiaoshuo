# 小说阅读系统功能设计文档

## 项目概述

本项目是一个小说阅读系统，支持多种格式的小说上传、阅读、搜索和社交功能。系统采用前后端分离架构，提供类似起点中文网的阅读体验。系统仅支持中文。

## 核心功能

### 1. 用户管理功能

#### 1.1 用户注册
- 邮箱格式验证注册
- 注册时可选择填写昵称，若未填写则默认使用邮箱作为昵称
- 使用第三方库如validator进行邮箱格式验证

#### 1.2 用户登录
- 邮箱和密码登录
- 使用JWT进行认证

#### 1.3 个人中心
- 展示用户基本信息和操作历史
- 昵称管理：用户可在个人中心修改昵称，默认昵称为登录邮箱

#### 1.4 用户状态管理
- 管理员可以冻结/解冻用户账户
- 被冻结用户无法进行上传、评论、评分、点赞等操作
- 但仍可登录和阅读已有的小说内容

  - 冻结用户功能限制：
    - 禁止操作：上传小说、发布评论、发布评分、点赞、设置小说分类和关键词
    - 允许操作：登录、阅读已有小说、查看个人中心信息
    - 阅读相关：允许更新阅读进度、记录阅读历史，但不会增加小说点击量

  - 冻结用户内容显示：
    - 内容保留：被冻结用户已发布的内容（评论、评分等）会保留在系统中
    - 冻结标识：在显示时标注"发布者已被冻结"的标签，标签样式为灰色徽章形式
    - 排序权重：冻结用户的评论和评分在排序中权重降低，不会影响热门排序
    - 界面标识：被冻结用户在界面上会显示"账户已被冻结"的水印或标识
    - 阅读进度处理：冻结用户的阅读进度和历史记录正常保存和显示
    - 阅读权限：冻结用户仍可阅读已有小说内容，但不会增加小说点击量

#### 1.5 管理员权限
- 通过is_admin字段标识管理员账户
- 管理员权限包括：审核小说、管理用户（冻结/解冻、查看用户列表）
- 删除内容（一键删除未审核小说、删除违规评论/评分）

### 2. 小说管理功能

#### 2.1 小说上传
- 支持txt、epub格式小说文件上传
- 文件大小限制最大20MB
- 包含文件hash验证防止重复上传
- 上传失败时提示错误信息
- 上传成功后等待后端完成文件解析后再刷新列表
- 小说上传必须登录用户才能操作

  - 章节管理：
    - 章节识别：
      - EPUB格式：使用第三方库如go-epub自动提取章节标题和结构
      - TXT格式：使用第三方库如go-regexp识别章节标记，包括：
        - 中文数字：/^第[一二三四五六七八九十百千万零]+[章节回].*$/
        - 阿拉伯数字：/^第\d+[章节回].*$/
        - 其他格式：/^序[言章]?$|^[前引]言$|^终[章后]$|^后记$/
    - 章节字数统计（使用第三方库如golang-runewidth）

  - 上传频率限制：
    - 每个用户每日上传小说数量限制为10本，按自然日（00:00-23:59）计算
    - 管理员用户不受此限制
    - 频次上传超过限制时提示"今日上传次数已达上限，请明天再试"

  - 文件存储路径管理：
    - 按状态分目录存放：
      - 审核中文件：存放在 pending 目录
      - 已通过文件：存放在 approved 目录  
      - 已拒绝文件：存放在 rejected 目录
    - 访问控制：
      - 所有小说文件访问需经过后端API验证
      - 防止直接访问文件路径
      - 验证用户权限和文件状态

#### 2.2 小说列表
- 展示系统中的所有小说
- 支持无限滚动分页

#### 2.3 小说详情
- 显示小说基本信息、简介、字数统计等

#### 2.4 小说分类
- 按不同类型分类展示小说

#### 2.5 阅读排行
- 按阅读次数排序展示小说（总榜、今日榜、本周榜、本月榜）

#### 2.6 审核机制
- 上传后小说默认为审核中状态
- 审核标准包括格式正确性、文件完整性等
- 审核操作包括通过、拒绝（可选择填写原因）、退回修改（可选择填写修改意见）等

  - 批量审核功能：
    - 支持多选操作：管理员在审核页面可通过复选框进行多选
    - 操作限制：一次最多可选择50本小说，以提高审核效率
    - 批量操作类型：支持批量通过、批量拒绝、批量退回修改

  - 审核时效管理：
    - 小说在审核中状态最长保留30天
    - 超过期限未审核的小说自动转为拒绝状态并通知上传用户

  - 通知机制：
    - 审核结果会通过系统消息通知上传用户
    - 系统消息包含标题、内容、类型和时间戳

#### 2.7 分类设置
- 必须登录用户才能为小说设置分类和关键词
- 当用户阅读进度按照字数位置的百分比达到20%以上时，可以在最后一页为小说设置分类和关键词

### 3. 阅读功能

#### 3.1 在线阅读
- 提供流畅的小说阅读体验
- 使用第三方库如epub.js实现epub格式解析，支持EPUB2和EPUB3格式
- 使用第三方库如marked或自定义解析器实现txt格式解析

  - 解析失败处理：
    - 如果解析失败，系统会显示错误信息并提供原始文件下载链接
    - 解析失败的小说在阅读页面显示提示："该小说文件解析失败，您可以选择下载原始文件"
    - 提供下载按钮供用户下载原始文件

#### 3.2 阅读进度
- 自动保存用户阅读进度到本地存储和服务器
- 按照字数位置的百分比存储和展示进度
- 阅读进度实时更新
- 用户再次打开的时候跳转到上次位置继续阅读

  - 阅读统计：
    - 记录阅读时长：
      - 统计规则：仅在页面可见且用户有交互时统计，暂停超过30秒则暂停计时
      - 实现方式：使用第三方库如moment.js计算阅读时间
      - 活跃度判断：结合鼠标移动、键盘输入等事件判断用户是否在阅读
      - 统计精度：精确到分钟

  - 跨设备同步机制：
    - 本地存储数据仅在当前设备和浏览器中有效
    - 服务器存储支持跨设备同步
    - 同步策略：当用户在多个设备上同时阅读时，以最新的阅读进度为准进行同步

  - 个性化设置：
    - 字体大小（范围[12-100px]，提供常用选项）
    - 字体类型（宋体、黑体、楷体、仿宋等标准Web字体）
    - 背景颜色（白、黑、灰、护眼绿等，提供预设主题）
    - 行间距（1.0-2.5倍，预设常用选项）
    - 阅读模式：
      - 滚动模式：连续滚动阅读，适合长篇内容
      - 翻页模式：模拟纸质书翻页效果
    - 夜间模式：
      - 手动切换：用户可手动开启/关闭夜间模式
      - 护眼模式：提供护眼主题
      - 记忆功能：记住用户当前使用的主题模式，在下次访问时自动应用

#### 3.3 翻页功能
- 点击阅读内容区域左侧30%实现上一页
- 点击右侧30%实现下页
- 支持覆盖翻页效果，可通过设置改成上下滚动翻页

### 4. 搜索功能

#### 4.1 小说搜索
- 基础搜索：按标题、作者、主角名称、小说字数等信息搜索小说
- 模糊搜索：支持模糊匹配
- 搜索结果排序：按匹配度、点击量、评分综合排序
- 搜索历史：保存用户搜索历史（最多保存20条记录）

### 5. 社交互动功能

#### 5.1 评论系统
- 必须登录用户才能对小说章节进行评论
- 每个用户对同一章节的评论数量限制为5条
- 用户可以删除自己发布的评论，但不能编辑评论
- 评论发布后无需审核，立即可见

  - 评论管理：
    - 评论排序：
      - 按时间排序：最新评论优先或最旧评论优先
      - 按点赞数排序：点赞数高的评论优先
    - 评论限制：
      - 同章节评论数：每个用户对同一章节的评论数量限制为5条
      - 评论长度：评论内容最多500字符
      - 评论频率：同一用户连续评论间隔不少于30秒
    - 评论互动：
      - 评论回复：支持对评论进行回复，形成评论线程
      - 评论点赞：用户可以对评论进行点赞，但不能重复点赞

  - 删除权限：
    - 普通用户：只能删除自己发布的评论
    - 管理员：可以删除任何用户的评论，删除时需记录操作日志

#### 5.2 评分系统
- 必须登录用户才能对小说进行评分
- 同时需要提供评分说明（用于对整个小说的评论展示，最多250个字符，非必填）
- 评分发布后无需审核，立即可见
- 用户不能编辑已发布的评分，只能删除
- 评分支持点赞

  - 评分统计：
    - 实时计算平均分
    - 评分分布统计（各星级评分数量及占比）
    - 简单的异常评分检测：对短时间内大量评分进行基础检测

  - 删除权限：
    - 普通用户：只能删除自己发布的评分
    - 管理员：可以删除任何用户的评分，删除时需记录操作日志

### 6. 分类管理功能
- 分类浏览：按分类浏览小说

## 界面设计

### 1. 底部导航栏
- 首页：推荐小说展示
- 分类：小说分类浏览
- 排行榜：阅读次数排行榜
- 上传：上传txt、epub格式小说
- 用户：用户个人中心、注册登录入口

### 2. 首页
- 顶部搜索框：按名称、作者、主角名称、小说字数等搜索小说
- 推荐小说列表：展示推荐小说（名称、logo图片）
- 无限滚动加载更多小说

### 3. 分类页
- 分类列表：展示各种小说分类
- 默认显示第一个分类的小说列表（名称、logo图片）
- 无限滚动加载更多小说

### 4. 排行榜页
- 顶部时间范围选择：总榜、今日榜、本周榜、本月榜
- 排行榜列表：按点击量排序展示小说（名称、logo图片）
- 无限滚动加载更多小说

### 5. 上传页
- 上传功能：支持单个或批量上传txt、epub格式文件
- 文件hash验证：上传前计算文件hash防止重复上传
- 上传进度显示
- 审核状态：上传后小说处于审核中状态
- 小说列表：默认展示审核中和已通过的小说
- 审核过滤：可选择是否过滤审核中的小说
- 无限滚动加载更多小说

### 6. 小说详情页
- 小说封面和基本信息
- 分类信息展示
- 关键词展示
- 简介和作者信息（部分展示）
- 评分和评论统计
- 章节目录
- 快速开始阅读按钮
- 相关推荐

### 7. 阅读页
- 顶部工具栏：返回、设置、目录
- 阅读内容区域
- 设置面板：字体、主题、间距
- 目录面板：章节列表
- 阅读模式：支持滚动模式和翻页模式
- 章节评论：在每一章的最后可以对小说的这一章节进行评论

## 交互设计

### 1. 响应式设计
- 桌面端：充分利用屏幕空间，多列布局
- 平板端：适中的内容宽度，优化触摸操作
- 手机端：单列布局，简化导航

### 2. 用户体验
- 页面加载：
  - 骨架屏或加载动画
  - 预加载热门小说内容以提升用户体验
  - 渐进式加载
- 操作反馈：
  - 成功/失败提示
  - 操作确认对话框（防止误操作）
  - 进度指示（上传、下载等长时间操作的进度显示）
- 错误处理：
  - 友好的错误提示
  - 错误上报机制
  - 网络异常处理（离线模式支持和重试机制）
- 无限滚动：自动加载更多内容
- 审核状态提示：明确显示小说审核状态

## 性能要求

### 1. 前端性能
- 页面加载时间 < 3秒
- 阅读页面响应时间 < 1秒
- 大型列表的高效渲染
- EPUB格式文件的快速解析

### 2. 后端性能
- API响应时间 < 500ms
- 数据库查询优化
- 静态资源加载优化
- 文件上传处理效率

## 安全要求

### 1. 数据安全
- 防止SQL注入
- 防止XSS攻击
- 输入内容过滤和验证

### 2. 文件安全
- 文件类型验证
- 文件大小限制
- 恶意文件检测
- 文件hash验证（防止重复上传）

## 部署方案
- 前后端分离部署
- 数据库独立部署
- 静态资源服务