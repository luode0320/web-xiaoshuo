# 小说阅读系统功能设计文档

## 项目概述

本项目是一个小说阅读系统，支持多种格式的小说上传、阅读、搜索和社交功能。
系统采用前后端分离架构，提供类似起点中文网的阅读体验。
系统仅支持中文。

## 核心功能

### 1. 用户管理功能

#### 1.1 用户注册
- 邮箱格式验证注册（使用第三方库validator进行邮箱格式验证）
- 注册时可选择填写昵称，若未填写则默认使用邮箱作为昵称

#### 1.2 用户登录
- 邮箱和密码登录
- 使用JWT进行认证

#### 1.3 个人中心
- 展示用户基本信息和操作历史
- 昵称管理：用户可在个人中心修改昵称，默认昵称为登录邮箱

#### 1.4 用户状态管理
- 管理员可以冻结/解冻用户账户
- 被冻结用户无法进行上传、评论、评分、点赞等操作
- 但仍可登录和阅读已有的小说内容

##### 1.4.1 冻结用户功能限制
- 禁止操作：上传小说、发布评论、发布评分、点赞、设置小说分类和关键词
- 允许操作：登录、阅读已有小说、查看个人中心信息
- 阅读相关：允许更新阅读进度、记录阅读历史，但不会增加小说点击量

##### 1.4.2 冻结用户内容显示
- 内容保留：被冻结用户已发布的内容（评论、评分等）会保留在系统中
- 冻结标识：在显示时标注"发布者已被冻结"的标签，标签样式为灰色徽章形式
- 排序权重：冻结用户的评论和评分在排序中权重降低，不会影响热门排序
- 界面标识：被冻结用户在界面上会显示"账户已被冻结"的水印或标识
- 阅读进度处理：冻结用户的阅读进度和历史记录正常保存和显示
- 阅读权限：冻结用户仍可阅读已有小说内容，但不会增加小说点击量

#### 1.5 管理员权限
- 通过is_admin字段标识管理员账户
- 管理员权限包括：审核小说、管理用户（冻结/解冻、查看用户列表）
- 删除内容（一键删除未审核小说、删除违规评论/评分）

### 2. 小说管理功能

#### 2.1 小说上传
- 支持txt、epub格式小说文件上传
- 文件大小限制最大20MB
- 包含文件hash验证防止重复上传
- 上传失败时提示错误信息
- 上传成功后等待后端完成文件解析后再刷新列表
- 小说上传必须登录用户才能操作

##### 2.1.1 章节管理
- 章节识别：
  - EPUB格式：使用第三方库go-epub自动提取章节标题和结构
  - TXT格式：使用第三方库go-regexp识别章节标记，包括：
    - 中文数字：/^第[一二三四五六七八九十百千万零]+[章节回].*$/
    - 阿拉伯数字：/^第\d+[章节回].*$/
    - 其他格式：/^序[言章]?$|^[前引]言$|^终[章后]$|^后记$/
- 章节字数统计（使用第三方库golang-runewidth）

##### 2.1.2 上传频率限制
- 每个用户每日上传小说数量限制为10本，按自然日（00:00-23:59）计算
- 管理员用户不受此限制
- 频次上传超过限制时提示"今日上传次数已达上限，请明天再试"

##### 2.1.3 文件存储路径管理
- 按状态分目录存放：
  - 审核中文件：存放在 pending 目录
  - 已通过文件：存放在 approved 目录  
  - 已拒绝文件：存放在 rejected 目录
- 访问控制：
  - 所有小说文件访问需经过后端API验证
  - 防止直接访问文件路径
  - 验证用户权限和文件状态

#### 2.2 小说列表
- 展示系统中的所有小说
- 支持无限滚动分页

#### 2.3 小说详情
- 显示小说基本信息、简介、字数统计等

#### 2.4 小说分类
- 按不同类型分类展示小说

#### 2.5 阅读排行
- 按阅读次数排序展示小说（总榜、今日榜、本周榜、本月榜）

#### 2.6 审核机制
- 审核状态：上传后小说默认为审核中状态（pending）
- 审核操作：包括通过（approved）、拒绝（rejected）、退回修改（returned）
- 审核权限：仅管理员用户可以进行审核操作

##### 2.6.1 审核标准
- 格式标准：
  - 文件格式正确（支持txt、epub格式）
  - 文件能被阅读器正常解析
  - 文件编码正确（支持UTF-8、GBK等常见编码）
- 完整性标准：
  - 文件无损坏，可以正常打开
  - 章节结构完整，无缺失章节
  - 文件内容完整，无截断
- 元数据标准：
  - 标题完整且格式正确
  - 作者信息完整（如未提供，可从文件提取）
  - 主角名称信息完整（如未提供，可从文件提取）
  - 简介内容合理
- 大小标准：
  - 文件大小在合理范围内（最小1KB，最大20MB）
  - 文件内容非空
- 内容标准：
  - 无明显乱码、特殊字符等影响阅读的内容
  - 无恶意代码或脚本
  - 内容符合平台规范（如无违规内容）

##### 2.6.2 审核流程
1. 上传后自动进入审核队列
   - 小说上传成功后自动标记为"审核中"状态
   - 进入管理员审核队列
   - 上传用户收到"上传成功，等待审核"的通知

2. 管理员审核操作
   - 管理员登录后台审核页面
   - 查看待审核小说列表
   - 点击查看小说详情和内容预览
   - 选择审核操作（通过/拒绝/退回修改）
   - 填写审核意见（对于拒绝或退回修改操作）

3. 审核结果处理
   - 通过：小说状态变为"已通过"，立即在前端显示
   - 拒绝：小说状态变为"已拒绝"，从公开列表中移除
   - 退回修改：小说状态保持"审核中"，但添加修改意见

4. 通知发送
   - 审核完成后，系统自动向上传用户发送通知
   - 通知包含审核结果和审核意见（如有）

##### 2.6.3 批量审核功能
- 多选操作：
  - 管理员在审核页面可通过复选框进行多选
  - 支持Ctrl+点击选择不连续项目
  - 支持Shift+点击选择连续项目
- 操作限制：
  - 一次最多可选择50本小说，以提高审核效率
  - 批量操作前显示确认对话框
- 批量操作类型：
  - 批量通过：将选中的小说全部标记为通过
  - 批量拒绝：将选中的小说全部标记为拒绝（可统一填写拒绝原因）
  - 批量退回修改：将选中的小说全部退回修改（可统一填写修改意见）
- 批量操作结果：
  - 显示批量操作结果统计（成功数量、失败数量）
  - 对于失败的操作，显示具体原因

##### 2.6.4 审核时效管理
- 审核期限：小说在审核中状态最长保留30天
- 自动处理：超过期限未审核的小说自动转为拒绝状态
- 定时任务：使用定时任务每24小时检查一次过期小说
- 通知机制：自动拒绝时向上传用户发送系统通知
- 处理记录：记录自动处理的操作日志

##### 2.6.5 审核界面设计
- 审核入口位置：
  - 管理员用户在底部导航栏点击"用户"图标进入个人中心
  - 在个人中心页面，管理员会看到额外的"审核管理"入口
  - 普通用户看不到审核管理入口
- 审核列表页面：
  - 显示待审核小说列表（标题、作者、上传时间、上传用户）
  - 每行左侧有复选框，支持批量选择
  - 支持按上传时间、文件大小、上传用户等排序
  - 支持搜索过滤
  - 显示待审核小说数量统计
  - 列表项操作：查看详情、直接通过、拒绝、退回修改
- 审核详情页面：
  - 显示小说完整信息（标题、作者、简介、字数等）
  - 提供"阅读小说"按钮，点击后在新页面打开阅读器预览内容
  - 显示章节结构概览
  - 提供审核操作按钮组
- 审核操作面板：
  - 通过按钮（绿色，支持单个通过和批量通过）
  - 拒绝按钮（红色，点击后弹出原因输入框）
  - 退回修改按钮（黄色，点击后弹出修改意见输入框）
  - 批量操作栏：当选择多个小说时，底部显示批量操作工具栏
- 批量审核功能：
  - 支持多选操作：通过复选框选择多个待审核小说
  - 支持Ctrl+点击选择不连续项目
  - 支持Shift+点击选择连续项目
  - 批量操作限制：一次最多可选择50本小说
  - 批量操作类型：批量通过、批量拒绝、批量退回修改
  - 批量操作确认：执行前显示确认对话框，显示选中数量

##### 2.6.6 审核权限管理
- 角色权限：
  - 仅管理员角色可以访问审核功能
  - 普通用户无法查看审核相关页面
- 操作日志：
  - 记录所有审核操作（操作人、操作时间、操作类型、操作对象）
  - 记录审核意见和原因
  - 支持操作日志查询和导出
- 审核统计：
  - 统计每日审核数量
  - 统计审核通过率
  - 统计平均审核时间
  - 生成审核报表

##### 2.6.7 通知机制
- 系统消息：审核结果会通过系统消息通知上传用户
- 消息内容：
  - 标题：如"您的小说《XXX》审核结果通知"
  - 内容：包含审核结果和审核意见
  - 类型：通知（notification）、警告（warning）、信息（info）
  - 时间戳：审核完成时间
- 消息状态：
  - 未读状态：用户未查看的消息
  - 已读状态：用户已查看的消息
  - 支持消息标记为已读和删除

##### 2.6.8 审核异常处理
- 文件解析失败：如果文件无法解析，自动标记为拒绝并通知用户
- 网络异常：审核过程中网络异常时，保存审核进度
- 并发审核：支持多个管理员同时审核不同的小说
- 审核冲突：同一小说被多个管理员审核时，以第一个完成的审核为准

#### 2.7 分类设置
- 必须登录用户才能为小说设置分类和关键词
- 当用户阅读进度按照字数位置的百分比达到20%以上时，可以在最后一页为小说设置分类和关键词

### 3. 阅读功能

#### 3.1 在线阅读
- 提供流畅的小说阅读体验
- 使用第三方库epub.js实现epub格式解析，支持EPUB2和EPUB3格式
- 使用第三方库marked或自定义解析器实现txt格式解析

##### 3.1.1 解析失败处理
- 如果解析失败，系统会显示错误信息并提供原始文件下载链接
- 解析失败的小说在阅读页面显示提示："该小说文件解析失败，您可以选择下载原始文件"
- 提供下载按钮供用户下载原始文件

#### 3.2 阅读进度
- 自动保存用户阅读进度到本地存储和服务器
- 按照字数位置的百分比存储和展示进度
- 阅读进度实时更新
- 用户再次打开的时候跳转到上次位置继续阅读

##### 3.2.1 阅读统计
- 记录阅读时长：
  - 统计规则：仅在页面可见且用户有交互时统计，暂停超过30秒则暂停计时
  - 实现方式：使用第三方库moment.js计算阅读时间
  - 活跃度判断：结合鼠标移动、键盘输入等事件判断用户是否在阅读
  - 统计精度：精确到分钟

##### 3.2.2 跨设备同步机制
- 本地存储数据仅在当前设备和浏览器中有效
- 服务器存储支持跨设备同步
- 同步策略：当用户在多个设备上同时阅读时，以最新的阅读进度为准进行同步

##### 3.2.3 个性化设置
- 字体大小（范围[12-100px]，提供常用选项）
- 字体类型（宋体、黑体、楷体、仿宋等标准Web字体）
- 背景颜色（白、黑、灰、护眼绿等，提供预设主题）
- 行间距（1.0-2.5倍，预设常用选项）
- 阅读模式：
  - 滚动模式：连续滚动阅读，适合长篇内容
  - 翻页模式：模拟纸质书翻页效果
- 夜间模式：
  - 手动切换：用户可手动开启/关闭夜间模式
  - 护眼模式：提供护眼主题
  - 记忆功能：记住用户当前使用的主题模式，在下次访问时自动应用

#### 3.3 翻页功能
- 点击阅读内容区域左侧30%实现上一页
- 点击右侧30%实现下页
- 支持覆盖翻页效果，可通过设置改成上下滚动翻页

### 4. 搜索功能

#### 4.1 小说搜索
- 基础搜索：按标题、作者、主角名称、小说字数等信息搜索小说
- 模糊搜索：支持模糊匹配（使用第三方库fuse.js实现，匹配度阈值设定为0.6）
- 搜索结果排序：按匹配度、点击量、评分综合排序
- 搜索历史：保存用户搜索历史（最多保存20条记录）

#### 4.2 高级搜索功能
- 多条件组合搜索：
  - 支持按分类筛选
  - 支持按字数范围筛选（如：10万字以下、10-50万字、50万字以上）
  - 支持按评分范围筛选（如：3星以上、4星以上）
  - 支持按上传时间筛选（如：最近一周、最近一个月、最近一年）
- 搜索字段选择：
  - 标题搜索（默认）
  - 作者搜索
  - 主角名称搜索
  - 小说简介搜索
  - 组合字段搜索
- 排序选项：
  - 相关度排序（默认）
  - 点击量排序（从高到低）
  - 评分排序（从高到低）
  - 上传时间排序（从新到旧）
  - 字数排序（从多到少）

#### 4.3 搜索建议功能
- 触发机制：用户输入时延迟300ms触发搜索建议
- 建议来源：
  - 搜索历史记录
  - 热门搜索关键词
  - 小说标题自动补全
  - 作者名称自动补全
- 显示数量：最多显示5条搜索建议
- 交互设计：
  - 鼠标悬停高亮显示
  - 键盘上下键导航
  - 回车键选择
  - 点击选择

#### 4.4 热门搜索功能
- 数据来源：基于近期的搜索数据统计
- 更新频率：每小时更新一次热门搜索列表
- 展示数量：最多展示10个热门关键词
- 展示位置：
  - 搜索框下方（当搜索框获得焦点时显示）
  - 搜索历史页面
  - 首页搜索区域
- 统计规则：
  - 统计过去24小时内的搜索次数
  - 排除无效搜索（如单个字符、特殊符号）
  - 去重处理（同一用户的重复搜索只计一次）

#### 4.5 搜索历史管理
- 存储方式：本地存储（localStorage）和服务器存储结合
- 存储数量：最多保存20条搜索记录
- 清理机制：
  - 自动清理超过30天的历史记录
  - 用户手动删除单条或全部历史记录
- 同步功能：登录用户可在不同设备间同步搜索历史

#### 4.6 搜索结果展示
- 列表视图：显示小说封面、标题、作者、简介、字数、评分等信息
- 网格视图：以卡片形式展示，适合移动端浏览
- 分页机制：支持无限滚动加载和传统分页
- 筛选选项：在搜索结果页面提供进一步的筛选功能
- 排序切换：允许用户在搜索结果页面切换排序方式

#### 4.7 搜索性能优化
- 索引优化：对搜索字段建立数据库索引
- 缓存策略：缓存热门搜索词和常见搜索结果
- 异步加载：搜索结果分页异步加载
- 防抖处理：搜索输入框添加防抖机制，减少不必要的搜索请求
- 预加载：预加载下一页搜索结果，提升用户体验

#### 4.8 搜索错误处理
- 无结果提示：当搜索结果为空时，显示友好的提示信息并提供搜索建议
- 网络错误处理：网络异常时显示重试按钮
- 输入验证：对搜索关键词进行基本验证（如长度、特殊字符等）
- 超时处理：搜索请求超时时提供反馈和重试选项

### 5. 社交互动功能

#### 5.1 评论系统
- 必须登录用户才能对小说章节进行评论
- 每个用户对同一章节的评论数量限制为5条
- 用户可以删除自己发布的评论，但不能编辑评论
- 评论发布后无需审核，立即可见

##### 5.1.1 评论管理
- 评论排序：
  - 按时间排序：最新评论优先或最旧评论优先
  - 按点赞数排序：点赞数高的评论优先
- 评论限制：
  - 同章节评论数：每个用户对同一章节的评论数量限制为5条
  - 评论长度：评论内容最多500字符
  - 评论频率：同一用户连续评论间隔不少于30秒
- 评论互动：
  - 评论回复：支持对评论进行回复，形成评论线程
  - 评论点赞：用户可以对评论进行点赞，但不能重复点赞

##### 5.1.2 删除权限
- 普通用户：只能删除自己发布的评论
- 管理员：可以删除任何用户的评论，删除时需记录操作日志

#### 5.2 评分系统
- 必须登录用户才能对小说进行评分
- 同时需要提供评分说明（用于对整个小说的评论展示，最多250个字符，非必填）
- 评分发布后无需审核，立即可见
- 用户不能编辑已发布的评分，只能删除
- 评分支持点赞

##### 5.2.1 评分统计
- 实时计算平均分
- 评分分布统计（各星级评分数量及占比）
- 简单的异常评分检测：对短时间内大量评分进行基础检测

##### 5.2.2 删除权限
- 普通用户：只能删除自己发布的评分
- 管理员：可以删除任何用户的评分，删除时需记录操作日志

### 6. 分类管理功能
- 分类浏览：按分类浏览小说

### 7. 推荐系统功能

#### 7.1 基于内容的推荐
- 推荐规则：推荐拥有相同分类或者关键字的小说
- 排序方式：按照阅读量排序的最多3本小说作为推荐
- 无阅读量处理：默认按ID排序
- 已读过滤：排除本地存储的已读小说
- 展示方式：在小说详情页向下滚动即可看到相关推荐

#### 7.2 热门推荐
- 计算方式：基于点击量、评分、评论数等综合评分推荐
  - 点击量权重：40%
  - 平均评分权重：30%
  - 评论数量权重：20%
  - 上传时间权重：10%（较新的小说有优势）
- 时间衰减：对较早的数据应用时间衰减因子
  - 每日衰减率：0.5%
  - 最大衰减时间：180天
- 更新频率：每小时更新一次热门推荐列表
- 缓存策略：使用Redis缓存热门推荐结果，减少数据库查询压力

#### 7.3 新书推荐
- 时间范围：最近7天内上传且审核通过的小说
- 质量筛选：仅推荐评分高于3星或评论数超过5条的小说
- 推荐逻辑：按上传时间倒序排列，结合质量指标进行微调
- 展示位置：在首页的新书推荐区域展示

#### 7.4 个性化推荐
- 算法实现：根据用户阅读历史和偏好推荐
  - 基于用户阅读的分类偏好
  - 基于用户评分的偏好分析
  - 基于用户评论的关键词提取
- 更新频率：推荐结果每日更新一次
- 推荐策略：结合基于内容的推荐，实现简单推荐算法
- 冷启动问题：对新用户使用热门推荐和分类推荐解决冷启动问题
- 数据收集：
  - 记录用户的阅读历史（小说ID、阅读时长、完成度）
  - 记录用户的评分历史（评分值、评分时间）
  - 记录用户的评论内容（关键词提取）

#### 7.5 推荐系统架构
- 数据层：MySQL存储用户行为数据，Redis缓存推荐结果
- 计算层：Go服务定期计算推荐结果
- API层：提供推荐接口供前端调用
- 监控层：监控推荐算法的准确性和性能

#### 7.6 推荐效果评估
- 点击率（CTR）：统计推荐内容的点击率
- 转化率：统计推荐后的阅读完成率
- 用户满意度：通过用户反馈评估推荐质量
- A/B测试：对不同推荐算法进行A/B测试

## 界面设计

### 1. 底部导航栏
- 首页：推荐小说展示
- 分类：小说分类浏览
- 排行榜：阅读次数排行榜
- 上传：上传txt、epub格式小说
- 用户：用户个人中心、注册登录入口

### 2. 首页
- 顶部搜索框：按名称、作者、主角名称、小说字数等搜索小说
- 推荐小说列表：展示推荐小说（名称、logo图片）
- 无限滚动加载更多小说

### 3. 分类页
- 分类列表：展示各种小说分类
- 默认显示第一个分类的小说列表（名称、logo图片）
- 无限滚动加载更多小说

### 4. 排行榜页
- 顶部时间范围选择：总榜、今日榜、本周榜、本月榜
- 排行榜列表：按点击量排序展示小说（名称、logo图片）
- 无限滚动加载更多小说

### 5. 上传页
- 上传功能：支持单个或批量上传txt、epub格式文件
- 文件hash验证：上传前计算文件hash防止重复上传
- 上传进度显示
- 审核状态：上传后小说处于审核中状态
- 小说列表：默认展示审核中和已通过的小说
- 审核过滤：可选择是否过滤审核中的小说
- 无限滚动加载更多小说

### 6. 小说详情页
- 小说封面和基本信息
- 分类信息展示
- 关键词展示
- 简介和作者信息（部分展示）
- 评分和评论统计
- 章节目录
- 快速开始阅读按钮
- 相关推荐

### 7. 阅读页
- 顶部工具栏：返回、设置、目录
- 阅读内容区域
- 设置面板：字体、主题、间距
- 目录面板：章节列表
- 阅读模式：支持滚动模式和翻页模式
- 章节评论：在每一章的最后可以对小说的这一章节进行评论

### 8. 用户模块

#### 8.1 个人中心页面
- 用户信息展示区：
  - 用户头像（默认头像或自定义）
  - 昵称和邮箱显示
  - 用户状态标识（正常/冻结）
  - 注册时间和最后登录时间
- 功能入口区：
  - 我的上传：查看和管理自己上传的小说
  - 我的评论：查看和管理自己发布的评论
  - 我的评分：查看和管理自己提交的评分
  - 阅读历史：查看阅读历史记录
  - 系统消息：查看系统通知和消息
  - 关于我们：查看项目信息和联系方式
  - 审核管理（仅管理员可见）：进入审核管理页面
- 操作区：
  - 编辑资料：修改昵称等个人信息
  - 退出登录：退出当前账户

#### 8.2 审核管理页面（仅管理员）
- 页面入口：在个人中心页面，管理员用户会看到"审核管理"入口
- 页面布局：
  - 顶部标题："审核管理"
  - 待审核小说数量统计
  - 搜索和筛选区域
  - 小说列表区域
  - 批量操作工具栏（当选择项目时显示）
- 小说列表项：
  - 左侧复选框，支持批量选择
  - 小说封面缩略图
  - 小说标题（可点击查看详情）
  - 作者和上传用户信息
  - 上传时间和文件大小
  - 操作按钮：通过、拒绝、退回修改
- 批量操作栏：
  - 显示已选择数量："已选择 X 个项目"
  - 批量通过按钮
  - 批量拒绝按钮
  - 批量退回修改按钮
  - 取消选择按钮

#### 8.3 关于我们页面
- 页面入口：在个人中心页面点击"关于我们"进入
- 页面内容：
  - 项目介绍：小说阅读系统的愿景和功能简介
  - 开发团队：团队信息和联系方式
  - 社交媒体链接：
    - 推特(Twitter)图标和链接
    - Telegram群组图标和链接
    - 其他社交媒体链接
  - 法律信息：
    - 使用条款链接
    - 隐私政策链接
  - 版本信息：
    - 当前版本号
    - 更新日志
    - 版权信息
- 页面设计：
  - 简洁清晰的布局
  - 图标化社交媒体链接
  - 响应式设计，适配移动端

#### 8.4 用户状态标识
- 正常用户：显示正常状态，所有功能可用
- 冻结用户：
  - 在个人中心显示"账户已被冻结"提示
  - 冻结标识（红色标签或图标）
  - 受限功能灰显或隐藏
  - 显示解冻说明或联系方式

## 交互设计

### 1. 响应式设计
- 桌面端：充分利用屏幕空间，多列布局
- 平板端：适中的内容宽度，优化触摸操作
- 手机端：单列布局，简化导航

### 2. 用户体验
- 页面加载：
  - 骨架屏或加载动画
  - 预加载热门小说内容以提升用户体验
  - 渐进式加载
- 操作反馈：
  - 成功/失败提示
  - 操作确认对话框（防止误操作）
  - 进度指示（上传、下载等长时间操作的进度显示）
- 错误处理：
  - 友好的错误提示
  - 错误上报机制
  - 网络异常处理（离线模式支持和重试机制）
- 无限滚动：自动加载更多内容
- 审核状态提示：明确显示小说审核状态

## 性能要求

### 1. 前端性能
- 页面加载时间 < 3秒
- 阅读页面响应时间 < 1秒
- 大型列表的高效渲染
- EPUB格式文件的快速解析

### 2. 后端性能
- API响应时间 < 500ms
- 数据库查询优化
- 静态资源加载优化
- 文件上传处理效率

## 安全要求

### 1. 数据安全
- 防止SQL注入
- 防止XSS攻击
- 输入内容过滤和验证

### 2. 文件安全
- 文件类型验证
- 文件大小限制
- 恶意文件检测
- 文件hash验证（防止重复上传）

## 部署方案
- 前后端分离部署
- 数据库独立部署
- 静态资源服务

## 后续扩展功能

### 1. 社交功能扩展
- 用户关注系统
- 更复杂的评论互动（多层级评论）
- 个性化推荐算法

### 2. 高级阅读功能
- 自定义主题和布局
- 高级阅读统计
- 书签和笔记功能

### 3. 高级管理功能
- 数据分析和报表
- 用户行为分析
- 高级审核工具